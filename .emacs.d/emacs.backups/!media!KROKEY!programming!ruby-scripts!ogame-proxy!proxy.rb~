require 'rubygems' 
require 'webrick/httpproxy'
require 'zlib'
require 'hpricot'


def process_bat(s)
	File.open("myfile", "a") do |file|
		file.puts s
	end

	doc = Hpricot(s)
	ele = doc.search("//table[@width='530']/tr")
	ele.each do |e|
		puts e.search('td')[2].inner_html
		
	end
end

def process_vue_gen(s)
end
 
server = WEBrick::HTTPProxyServer.new(
    :Port => 8080,
    :AccessLog => [],
	:ProxyContentHandler => Proc.new do |req,res|
		if res['content-type'] =~ %r!text/html!
			body = res.body
			if res.header["content-encoding"] == "gzip"
			  Zlib::GzipReader.wrap(StringIO.new(res.body)){|gz| body = gz.read}
			  case req.request_line.chomp
			  when /page=overview/
			  	puts "'Vue générale' détectée."
				process_vue_gen(body)
			  when /page=b_building/
			  	puts "'Bâtiments' détectés."
				process_bat(body)
				when /page=buildings.*Forschung/
				puts "'Laboratoire' détecté."
				when /page=buildings.*Flotte/
				puts "'Chantier spatial' détecté."
				when /page=flotten1/
				puts "'Flotte' détectée."
				when /page=buildings.*Verteidigung/
				puts "'Défense' détectée."
			  end
			end
		  end
	end

)
trap("INT") { server.shutdown }
server.start


